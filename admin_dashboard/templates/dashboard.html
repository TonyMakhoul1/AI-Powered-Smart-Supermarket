<!DOCTYPE html>
<html>

<head>
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>

<body class="container py-4">

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-3">
        {% for category, msg in messages %}
        <div class="alert alert-{{ category }}">{{ msg }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <h1 class="mb-4">Supermarket Admin Dashboard</h1>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-white bg-primary mb-3">
                <div class="card-body">
                    <h5 class="card-title">Total Customers</h5>
                    <p class="card-text fs-3"> {{ stats.total }}</p>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card text-white bg-success mb-3">
                <div class="card-body">
                    <h5 class="card-title">Male Customers</h5>
                    <p class="card-text fs-3"> {{ stats.male }}</p>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card text-white bg-danger mb-3">
                <div class="card-body">
                    <h5 class="card-title">Female Customers</h5>
                    <p class="card-text fs-3"> {{ stats.female }}</p>
                </div>
            </div>
        </div>
    </div>

    <form method="get" class="row mb-4">
        <div class="col-md-3">
            <select name="gender" class="form-select">
                <option value="">All Genders</option>
                {% for g in genders %}
                <option value="{{ g }}" {% if request.args.get('gender')==g %}selected{% endif %}>{{ g }}</option>
                {% endfor %}
            </select>
        </div>



        <div class="col-md-2">
            <input type="number" name="age_min" class="form-control" placeholder="Min Age"
                value="{{ request.args.get('age_min', '') }}">
        </div>

        <div class="col-md-2">
            <input type="number" name="age_max" class="form-control" placeholder="Max Age"
                value="{{ request.args.get('age_max', '') }}">
        </div>


        <div class="col-md-3">
            <select name="emotion" class="form-select">
                <option value="">All Emotions</option>
                {% for e in emotions %}
                <option value="{{ e }}" {% if request.args.get('emotion')==e %}selected{% endif %}>{{ e }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <input type="date" name="visit_date" class="form-control" value="{{ request.args.get('visit_date', '') }}">
        </div>

        <div class="col-md-3">
            <button type="submit" class="btn btn-primary w-100">Filter</button>
        </div>

        <div class="col-md-3">
            <button type="submit" name="action" value="reset" class="btn btn-secondary w-100">Reset</button>
        </div>
    </form>


    <h3>Registered Customers</h3>
    <form method="post" action="{{ url_for('send_messages') }}">

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all"></th>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>Gender</th>
                    <th>DOB</th>
                    <th>Age</th>
                    <th>Last Emotion</th>
                    <th>Last Visit</th>
                </tr>
            </thead>
            <tbody>
                {% for c in customers %}
                <tr>
                    <td><input type="checkbox" name="selected_customers" value="{{ c.get('phone_number') }}"></td>
                    <td>{{ c.get('name', 'N/A') }}</td>
                    <td>{{ c.get('phone_number', 'N/A') }}</td>
                    <td>{{ c.get('gender', 'N/A') }}</td>
                    <td>{{ c.get('dob', 'N/A') }}</td>
                    <td>{{ c.get('age', 'N/A') }}</td>
                    <td>{{ c.get('last_emotion', 'N/A') }}</td>
                    <td>{{ c.get('last_visit', 'N/A') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <input type="hidden" name="gender" value="{{ request.args.get('gender', '') }}">
        <input type="hidden" name="emotion" value="{{ request.args.get('emotion', '') }}">
        <input type="hidden" name="visit_date" value="{{ request.args.get('visit_date', '') }}">
        <input type="hidden" name="age_min" value="{{ request.args.get('age_min', '') }}">
        <input type="hidden" name="age_max" value="{{ request.args.get('age_max', '') }}">



        <div class="mb-3">
            <textarea name="message" class="form-control" rows="3" placeholder="Enter your message..."></textarea>
        </div>

        <button type="submit" name="action" value="selected" class="btn btn-success">Send to Selected</button>
        <button type="submit" name="action" value="filtered" class="btn btn-primary">Send to All Filtered</button>
    </form>

    <script>
        let selectAll = document.getElementById("select-all");
        if (selectAll) {
            selectAll.addEventListener("click", function () {
                let checkboxes = document.querySelectorAll('input[name="selected_customers"]');
                checkboxes.forEach(cb => cb.checked = this.checked);
            });
        }

    </script>
</body>

</html>